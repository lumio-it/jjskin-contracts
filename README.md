# JJSKIN æ™ºèƒ½åˆçº¦

> CS2 çš®è‚¤å»ä¸­å¿ƒåŒ–äº¤æ˜“å¸‚åœº - åŸºäº Arbitrum çš„ USDC æ‰˜ç®¡äº¤æ˜“ç³»ç»Ÿ

## ğŸ“‹ ç›®å½•

- [ç³»ç»Ÿæ¦‚è¿°](#ç³»ç»Ÿæ¦‚è¿°)
- [è§’è‰²ä¸æƒé™](#è§’è‰²ä¸æƒé™)
- [æ ¸å¿ƒæµç¨‹](#æ ¸å¿ƒæµç¨‹)
- [è®¾è®¡è€ƒé‡](#è®¾è®¡è€ƒé‡)
- [åˆçº¦æ¶æ„](#åˆçº¦æ¶æ„)
- [å®‰å…¨æ¨¡å‹](#å®‰å…¨æ¨¡å‹)
- [Gas ä¼˜åŒ–](#gas-ä¼˜åŒ–)

---

## ç³»ç»Ÿæ¦‚è¿°

JJSKIN æ˜¯ä¸€ä¸ªå°† Steam æ¸¸æˆèµ„äº§ä¸åŒºå—é“¾æŠ€æœ¯ç»“åˆçš„å»ä¸­å¿ƒåŒ–å¸‚åœºã€‚ç”¨æˆ·å¯ä»¥ä½¿ç”¨ USDC ç¨³å®šå¸ä¹°å– CS2 çš®è‚¤ï¼Œæ‰€æœ‰äº¤æ˜“é€šè¿‡æ™ºèƒ½åˆçº¦æ‰˜ç®¡ï¼Œç¡®ä¿èµ„é‡‘å®‰å…¨ã€‚

### æ ¸å¿ƒç‰¹ç‚¹

| ç‰¹æ€§ | è¯´æ˜ |
|------|------|
| **é“¾ä¸‹ç­¾åä¸Šé“¾éªŒè¯** | å–å®¶åœ¨é“¾ä¸‹ç­¾ç½² EIP-712 æ ¼å¼çš„æŒ‚å•ï¼Œä¹°å®¶è´­ä¹°æ—¶æ‰ä¸Šé“¾ |
| **Oracle ä¿¡ä»»æ¨¡å‹** | æ‰€æœ‰æ—¶é—´éªŒè¯åœ¨é“¾ä¸‹é€šè¿‡ TLSNotary è¯æ˜å®Œæˆ |
| **ERC-4626 æ”¶ç›Š** | é—²ç½®æ‰˜ç®¡èµ„é‡‘è‡ªåŠ¨å­˜å…¥æ”¶ç›Šé‡‘åº“ç”Ÿæ¯ |
| **æ‰¹é‡æ“ä½œ** | æ”¯æŒæ‰¹é‡é‡Šæ”¾èµ„é‡‘ï¼ŒèŠ‚çœ Gas |
| **æ™ºèƒ½è´¦æˆ·æ”¯æŒ** | æ”¯æŒ ERC-1271 æ™ºèƒ½é’±åŒ…ç­¾åéªŒè¯ |

### æŠ€æœ¯æ ˆ

- **Solidity**: 0.8.30
- **æ¡†æ¶**: Foundry
- **ç½‘ç»œ**: Arbitrum Sepolia (æµ‹è¯•ç½‘) â†’ Arbitrum One (ä¸»ç½‘)
- **ä»£å¸**: USDC (6 ä½å°æ•°)

---

## è§’è‰²ä¸æƒé™

### ğŸ”‘ Owner (åˆçº¦æ‰€æœ‰è€…)

**èŒè´£**: åˆçº¦ç®¡ç†ä¸é…ç½®

| æƒé™ | å‡½æ•° | è¯´æ˜ |
|------|------|------|
| è®¾ç½® Oracle | `setOracle(address)` | æŒ‡å®šå¯ä¿¡çš„ Oracle åœ°å€ |
| è®¾ç½®æ‰‹ç»­è´¹æ¥æ”¶è€… | `setFeeRecipient(address)` | æŒ‡å®šå¹³å°æ”¶ç›Šæ¥æ”¶åœ°å€ |
| è°ƒæ•´æ‰‹ç»­è´¹ç‡ | `setPlatformFee(uint256)` | æœ€é«˜ 5% (500 åŸºç‚¹) |
| æš‚åœ/æ¢å¤åˆçº¦ | `pause()` / `unpause()` | ç´§æ€¥æƒ…å†µä¸‹æš‚åœæ‰€æœ‰äº¤æ˜“ |
| è®¾ç½®æ”¶ç›Šé‡‘åº“ | `setYieldVault(address)` | ä¸€æ¬¡æ€§è®¾ç½® ERC-4626 é‡‘åº“ |
| è°ƒæ•´æ—¶é—´çª—å£ | `setDeliveryWindow()` ç­‰ | é…ç½®äº¤æ˜“è¶…æ—¶å‚æ•° |
| ç´§æ€¥ææ¬¾ | `emergencyWithdrawFromVault()` | ä»é‡‘åº“ç´§æ€¥æ’¤å›èµ„é‡‘ |

**å®‰å…¨è®¾è®¡**: ä½¿ç”¨ `Ownable2Step`ï¼Œæ‰€æœ‰æƒè½¬ç§»éœ€è¦æ–° Owner ç¡®è®¤æ¥å—ã€‚

---

### ğŸ”® Oracle (é¢„è¨€æœº)

**èŒè´£**: é“¾ä¸‹éªŒè¯äº¤æ˜“å®ŒæˆçŠ¶æ€ï¼Œé“¾ä¸Šæ‰§è¡Œèµ„é‡‘é‡Šæ”¾/é€€æ¬¾

| æƒé™ | å‡½æ•° | è¯´æ˜ |
|------|------|------|
| æ‰¹é‡é‡Šæ”¾èµ„é‡‘ | `batchReleaseFunds(AssetId[])` | éªŒè¯äº¤æ˜“å®Œæˆåé‡Šæ”¾å–å®¶èµ„é‡‘ |
| é€€æ¬¾ | `oracleRefund(AssetId, RefundReason, bool)` | å¤„ç†å¤±è´¥äº¤æ˜“çš„é€€æ¬¾ |
| æš‚åœå–å®¶ | `suspendSeller(address)` | æš‚åœè¿è§„å–å®¶ |
| æ¢å¤å–å®¶ | `unsuspendSeller(address)` | æ¢å¤è¢«æš‚åœçš„å–å®¶ |

**ä¿¡ä»»æ¨¡å‹**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Oracle çš„å†³å®šæ˜¯æœ€ç»ˆçš„ï¼Œä½†åŸºäº TLSNotary å¯†ç å­¦è¯æ˜         â”‚
â”‚                                                             â”‚
â”‚  1. ç›‘æ§ Steam äº¤æ˜“çŠ¶æ€ (é€šè¿‡æµè§ˆå™¨æ‰©å±•)                    â”‚
â”‚  2. ç”Ÿæˆ TLSNotary è¯æ˜ (ä¸å¯ä¼ªé€ )                          â”‚
â”‚  3. è¯æ˜å…¬å¼€å‘å¸ƒä¾›å®¡è®¡                                      â”‚
â”‚  4. è°ƒç”¨åˆçº¦é‡Šæ”¾/é€€æ¬¾                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æœªæ¥è§„åˆ’**: å¼•å…¥ OracleRegistry åˆçº¦å®ç°è´¨æŠ¼/æƒ©ç½šæœºåˆ¶ã€‚

---

### ğŸ’° Seller (å–å®¶)

**èŒè´£**: æŒ‚å•å‡ºå”® CS2 çš®è‚¤

| æ“ä½œ | è¯´æ˜ |
|------|------|
| ç­¾ç½²æŒ‚å• | é“¾ä¸‹ç­¾ç½² EIP-712 æ ¼å¼çš„æŒ‚å•æ•°æ® |
| å‘é€äº¤æ˜“æŠ¥ä»· | ä¹°å®¶è´­ä¹°åï¼Œé€šè¿‡ Steam å‘é€äº¤æ˜“æŠ¥ä»· |
| æå–æ”¶ç›Š | äº¤æ˜“å®Œæˆåè°ƒç”¨ `withdrawBalance()` |

**è¦æ±‚**:
- å¿…é¡»é€šè¿‡ `SteamAccountFactory` æ³¨å†Œé’±åŒ…
- ä¸èƒ½è¢«æš‚åœ (`suspendedSellers[seller] == false`)

---

### ğŸ›’ Buyer (ä¹°å®¶)

**èŒè´£**: è´­ä¹° CS2 çš®è‚¤

| æ“ä½œ | å‡½æ•° | è¯´æ˜ |
|------|------|------|
| ç›´æ¥è´­ä¹° | `purchaseWithSignature()` | ä½¿ç”¨å–å®¶ç­¾åç›´æ¥è´­ä¹° |
| åˆ›å»ºä¹°å• | `createBuyOrder()` | åˆ›å»ºæ‰¹é‡è´­ä¹°è®¢å• |
| å–æ¶ˆä¹°å• | `cancelBuyOrder()` | å–æ¶ˆæœªå®Œæˆçš„ä¹°å• |
| æ¥å—äº¤æ˜“ | Steam å®¢æˆ·ç«¯ | æ¥å—å–å®¶å‘é€çš„äº¤æ˜“æŠ¥ä»· |
| æå–é€€æ¬¾ | `withdrawBalance()` | äº¤æ˜“å¤±è´¥åæå–é€€æ¬¾ |

**è¦æ±‚**:
- å¿…é¡»é€šè¿‡ `SteamAccountFactory` æ³¨å†Œé’±åŒ…
- æ‹¥æœ‰è¶³å¤Ÿçš„ USDC ä½™é¢æˆ–æˆæƒ

---

### ğŸ¦ Fee Recipient (æ‰‹ç»­è´¹æ¥æ”¶è€…)

**èŒè´£**: æ¥æ”¶å¹³å°äº¤æ˜“æ‰‹ç»­è´¹

| æ“ä½œ | å‡½æ•° | è¯´æ˜ |
|------|------|------|
| æå–æ‰‹ç»­è´¹ | `withdrawFees()` | æå–ç´¯ç§¯çš„å¹³å°æ‰‹ç»­è´¹ |
| å­˜å…¥é‡‘åº“ | `depositFeesToVault()` | å°†æ‰‹ç»­è´¹å­˜å…¥æ”¶ç›Šé‡‘åº“ |
| æ”¶å‰²æ”¶ç›Š | `harvestYield()` | ä»é‡‘åº“æå–ç”Ÿæˆçš„æ”¶ç›Š |

---

## æ ¸å¿ƒæµç¨‹

### ğŸ“¦ ç›´æ¥è´­ä¹°æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å–å®¶    â”‚     â”‚  ä¹°å®¶    â”‚     â”‚  åˆçº¦    â”‚     â”‚  Oracle  â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
     â”‚                â”‚                â”‚                â”‚
     â”‚ 1. ç­¾ç½²æŒ‚å•    â”‚                â”‚                â”‚
     â”‚ (EIP-712)      â”‚                â”‚                â”‚
     â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                â”‚                â”‚
     â”‚                â”‚                â”‚                â”‚
     â”‚                â”‚ 2. è´­ä¹°        â”‚                â”‚
     â”‚                â”‚ purchaseWith   â”‚                â”‚
     â”‚                â”‚ Signature()    â”‚                â”‚
     â”‚                â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                â”‚
     â”‚                â”‚                â”‚                â”‚
     â”‚                â”‚                â”‚ éªŒè¯ç­¾å       â”‚
     â”‚                â”‚                â”‚ é”å®š USDC      â”‚
     â”‚                â”‚                â”‚ åˆ›å»º Purchase  â”‚
     â”‚                â”‚                â”‚                â”‚
     â”‚ 3. å‘é€ Steam  â”‚                â”‚                â”‚
     â”‚    äº¤æ˜“æŠ¥ä»·    â”‚                â”‚                â”‚
     â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                â”‚                â”‚
     â”‚                â”‚                â”‚                â”‚
     â”‚ 4. æ¥å—äº¤æ˜“    â”‚                â”‚                â”‚
     â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                â”‚                â”‚
     â”‚                â”‚                â”‚                â”‚
     â”‚                â”‚                â”‚ 5. TLSNotary   â”‚
     â”‚                â”‚                â”‚    è¯æ˜éªŒè¯    â”‚
     â”‚                â”‚                â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
     â”‚                â”‚                â”‚                â”‚
     â”‚                â”‚                â”‚ 6. é‡Šæ”¾èµ„é‡‘    â”‚
     â”‚                â”‚                â”‚ batchRelease   â”‚
     â”‚                â”‚                â”‚ Funds()        â”‚
     â”‚                â”‚                â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
     â”‚                â”‚                â”‚                â”‚
     â”‚ 7. æå–æ”¶ç›Š    â”‚                â”‚                â”‚
     â”‚ withdrawBalance()               â”‚                â”‚
     â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                â”‚
     â”‚                â”‚                â”‚                â”‚
```

### ğŸ“‹ ä¹°å•æµç¨‹

```
1. ä¹°å®¶åˆ›å»ºä¹°å•
   createBuyOrder(itemSpec, maxPrice, quantity)
   â†’ é”å®š maxPrice Ã— quantity çš„ USDC

2. å–å®¶åŒ¹é…ä¹°å•
   executeBuyOrderMatchWithSignature(orderId, listing, seller, signature)
   â†’ éªŒè¯ itemSpec åŒ¹é…
   â†’ éªŒè¯ä»·æ ¼ â‰¤ maxPrice
   â†’ åˆ›å»º Purchase

3. äº¤æ˜“å®Œæˆ
   â†’ Oracle éªŒè¯åé‡Šæ”¾èµ„é‡‘
   â†’ å‰©ä½™é‡‘é¢å¯å–æ¶ˆè¿”è¿˜

4. äº¤æ˜“å¤±è´¥
   â†’ Oracle é€€æ¬¾
   â†’ ä¹°å•æ•°é‡æ¢å¤ (å¯ç»§ç»­åŒ¹é…)
```

### ğŸ”„ é€€æ¬¾æµç¨‹

```solidity
enum RefundReason {
    FailedDelivery,   // å–å®¶æœªå‘é€äº¤æ˜“æŠ¥ä»·
    TradeReversed,    // å–å®¶æ’¤é”€ Steam äº¤æ˜“ (æ¶æ„)
    TradeDeclined,    // ä¹°å®¶æ‹’ç»äº¤æ˜“æŠ¥ä»·
    Expired,          // äº¤æ˜“è¶…æ—¶æœªå®Œæˆ
    Other             // å…¶ä»–åŸå› 
}
```

| é€€æ¬¾åŸå›  | å–å®¶å¤„ç† | è¯´æ˜ |
|----------|----------|------|
| `FailedDelivery` | å¯æš‚åœ | Oracle å†³å®šæ˜¯å¦æš‚åœ |
| `TradeReversed` | **å¿…é¡»æš‚åœ** | æ¶æ„è¡Œä¸ºï¼Œå¼ºåˆ¶æš‚åœ |
| `TradeDeclined` | ä¸æš‚åœ | ä¹°å®¶è´£ä»» |
| `Expired` | å¯æš‚åœ | Oracle å†³å®š |
| `Other` | å¯æš‚åœ | Oracle å†³å®š |

---

## è®¾è®¡è€ƒé‡

### 1. ä¸ºä»€ä¹ˆä½¿ç”¨é“¾ä¸‹ç­¾åï¼Ÿ

```
ä¼ ç»Ÿæ–¹å¼:
å–å®¶æŒ‚å• â†’ ä¸Šé“¾ (Gas) â†’ ä¹°å®¶è´­ä¹° â†’ ä¸Šé“¾ (Gas)
= 2 ç¬”äº¤æ˜“ Gas

JJSKIN æ–¹å¼:
å–å®¶ç­¾å â†’ é“¾ä¸‹å­˜å‚¨ â†’ ä¹°å®¶è´­ä¹° â†’ ä¸Šé“¾ (Gas)
= 1 ç¬”äº¤æ˜“ Gas (èŠ‚çœ 50%+)
```

**ä¼˜åŠ¿**:
- âœ… æŒ‚å•å… Gas
- âœ… å¯éšæ—¶ä¿®æ”¹/å–æ¶ˆ (æ¢ç­¾åå³å¯)
- âœ… æ”¯æŒæ‰¹é‡æŒ‚å•
- âœ… æ›´å¥½çš„ç”¨æˆ·ä½“éªŒ

### 2. ä¸ºä»€ä¹ˆ Oracle è¢«å®Œå…¨ä¿¡ä»»ï¼Ÿ

**è®¾è®¡æƒè¡¡**:

| æ–¹æ¡ˆ | ä¼˜ç‚¹ | ç¼ºç‚¹ |
|------|------|------|
| é“¾ä¸Šæ—¶é—´éªŒè¯ | å»ä¸­å¿ƒåŒ– | æ— æ³•éªŒè¯ Steam çŠ¶æ€ |
| ä¹è§‚ Oracle | å¯æŒ‘æˆ˜ | éœ€è¦è´¨æŠ¼/æŒ‘æˆ˜æœŸ |
| **ä¿¡ä»» Oracle + TLSNotary** | ç®€å•é«˜æ•ˆ | å•ç‚¹ä¿¡ä»» |

**æˆ‘ä»¬çš„é€‰æ‹©**: ä¿¡ä»» Oracleï¼Œä½†æ‰€æœ‰è¯æ˜å…¬å¼€å¯å®¡è®¡

```
TLSNotary è¯æ˜æµç¨‹:
1. æµè§ˆå™¨æ‰©å±•æ•è· Steam API å“åº”
2. ç”Ÿæˆä¸å¯ä¼ªé€ çš„å¯†ç å­¦è¯æ˜
3. è¯æ˜åŒ…å«: äº¤æ˜“çŠ¶æ€ã€æ—¶é—´æˆ³ã€ç­¾å
4. è¯æ˜å…¬å¼€å­˜å‚¨ä¾›ä»»ä½•äººéªŒè¯
```

**æœªæ¥æ”¹è¿›**:
- [ ] å¤šç­¾ Oracle (2-of-3)
- [ ] å¤§é¢äº¤æ˜“æ—¶é—´é”
- [ ] Oracle è´¨æŠ¼/æƒ©ç½šæœºåˆ¶

### 3. ä¸ºä»€ä¹ˆåˆå¹¶ Purchase + Escrowï¼Ÿ

**ä¼ ç»Ÿè®¾è®¡**:
```solidity
struct Purchase {
    address buyer;
    uint256 purchaseTime;
    // ... å…¶ä»–å­—æ®µ
}

struct Escrow {
    uint256 amount;
    uint256 releaseTime;
    EscrowStatus status;
    // ... å…¶ä»–å­—æ®µ
}
// = 2 ä¸ª mappingï¼Œå¤šæ¬¡ SSTORE
```

**JJSKIN è®¾è®¡**:
```solidity
struct Purchase {
    address buyer;        // 20 bytes
    uint40 purchaseTime;  // 5 bytes  (å¤Ÿç”¨åˆ° 36812 å¹´)
    PurchaseStatus status;// 1 byte   (enum = uint8)
    // Total: 26 bytes = 1 SLOT
}
```

**èŠ‚çœ**: æ¯ç¬”äº¤æ˜“èŠ‚çœ ~20,000 Gas (å°‘ä¸€æ¬¡ SSTORE)

### 4. ä¸ºä»€ä¹ˆ batchReleaseFunds è·³è¿‡æ— æ•ˆäº¤æ˜“è€Œä¸å›æ»šï¼Ÿ

```solidity
// å½“å‰è®¾è®¡: è·³è¿‡æ— æ•ˆ
if (purchase.status != PurchaseStatus.Active) continue;

// æ›¿ä»£è®¾è®¡: å›æ»š
if (purchase.status != PurchaseStatus.Active) revert InvalidTradeState();
```

**è·³è¿‡è®¾è®¡çš„ä¼˜åŠ¿**:
- âœ… ä¸€ç¬”äº¤æ˜“å¤±è´¥ä¸å½±å“å…¶ä»–äº¤æ˜“
- âœ… Oracle å¯å®‰å…¨é‡è¯•
- âœ… æ›´é€‚åˆæ‰¹é‡æ“ä½œåœºæ™¯
- âœ… å¹‚ç­‰æ€§ (å¤šæ¬¡è°ƒç”¨ç»“æœä¸€è‡´)

### 5. ä¸ºä»€ä¹ˆéœ€è¦ SteamAccountFactoryï¼Ÿ

```
é—®é¢˜: å¦‚ä½•å…³è” Steam è´¦å·å’Œé’±åŒ…åœ°å€ï¼Ÿ

è§£å†³æ–¹æ¡ˆ: SteamAccountFactory åˆçº¦
1. ç”¨æˆ·é€šè¿‡ Steam OAuth éªŒè¯
2. åç«¯éªŒè¯åè°ƒç”¨ Factory æ³¨å†Œ
3. Steam ID â†” é’±åŒ…åœ°å€ æ˜ å°„å­˜å‚¨åœ¨é“¾ä¸Š
4. äº¤æ˜“æ—¶éªŒè¯åŒæ–¹éƒ½å·²æ³¨å†Œ
```

**å®‰å…¨ä¿è¯**:
- åªæœ‰éªŒè¯è¿‡çš„ç”¨æˆ·å¯ä»¥äº¤æ˜“
- é˜²æ­¢æœªæ³¨å†Œç”¨æˆ·æ¥æ”¶äº¤æ˜“æŠ¥ä»·
- ä¾¿äº Oracle è¿½è¸ªäº¤æ˜“åŒæ–¹

---

## åˆçº¦æ¶æ„

### ä¸»è¦åˆçº¦

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  JJSKIN.sol                                                 â”‚
â”‚  â”œâ”€â”€ Ownable2Step (æƒé™ç®¡ç†)                                â”‚
â”‚  â”œâ”€â”€ Pausable (ç´§æ€¥æš‚åœ)                                    â”‚
â”‚  â”œâ”€â”€ EIP712 (ç»“æ„åŒ–ç­¾å)                                    â”‚
â”‚  â””â”€â”€ è‡ªå®šä¹‰ ReentrancyGuard                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  CS2AaveVault.sol (ERC-4626)                                â”‚
â”‚  â””â”€â”€ é—²ç½®èµ„é‡‘è‡ªåŠ¨å­˜å…¥ Aave ç”Ÿæ¯                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ISteamAccountFactory.sol (æ¥å£)                            â”‚
â”‚  â””â”€â”€ Steam è´¦å· â†” é’±åŒ…åœ°å€æ˜ å°„                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ•°æ®ç»“æ„

```solidity
// ç”¨æˆ·è‡ªå®šä¹‰å€¼ç±»å‹ (ç±»å‹å®‰å…¨)
type AssetId is uint64;      // Steam èµ„äº§ ID
type BuyOrderId is uint64;   // ä¹°å• ID
type ItemSpec is uint48;     // ç‰©å“è§„æ ¼ (skin type + wear)

// æŒ‚å• (32 bytes = 1 slot)
struct Listing {
    address seller;   // 20 bytes
    uint56 price;     // 7 bytes  (æœ€å¤§ ~72 ä¸‡äº¿ USDC)
    bool exists;      // 1 byte
    uint32 reserved;  // 4 bytes  (å¯¹é½å¡«å……)
}

// è´­ä¹°è®°å½• (26 bytes = 1 slot)
struct Purchase {
    address buyer;              // 20 bytes
    uint40 purchaseTime;        // 5 bytes
    PurchaseStatus status;      // 1 byte
}

// è´­ä¹°çŠ¶æ€
enum PurchaseStatus {
    Active,    // äº¤æ˜“è¿›è¡Œä¸­ï¼Œèµ„é‡‘æ‰˜ç®¡
    Released,  // Oracle ç¡®è®¤ï¼Œå–å®¶å·²æ”¶æ¬¾
    Refunded   // å·²é€€æ¬¾ï¼Œä¹°å®¶å·²æ”¶å›
}
```

---

## å®‰å…¨æ¨¡å‹

### âœ… å·²å®ç°çš„å®‰å…¨æªæ–½

| æªæ–½ | å®ç° | è¯´æ˜ |
|------|------|------|
| é‡å…¥ä¿æŠ¤ | `nonReentrant` | æ‰€æœ‰å¤–éƒ¨çŠ¶æ€ä¿®æ”¹å‡½æ•° |
| æƒé™æ§åˆ¶ | `onlyOwner`, `onlyOracle` | åˆ†ç¦»çš„æƒé™è§’è‰² |
| æš‚åœæœºåˆ¶ | `whenNotPaused` | ç´§æ€¥æƒ…å†µå¯æš‚åœ |
| åŒé‡æ‰€æœ‰æƒè½¬ç§» | `Ownable2Step` | é˜²æ­¢æ„å¤–ä¸¢å¤±æ‰€æœ‰æƒ |
| å®‰å…¨è½¬è´¦ | `SafeERC20` | é˜²æ­¢éæ ‡å‡† ERC20 é—®é¢˜ |
| è‡ªå®šä¹‰é”™è¯¯ | 26 ä¸ªè‡ªå®šä¹‰ Error | Gas é«˜æ•ˆçš„é”™è¯¯å¤„ç† |
| æ‰‹ç»­è´¹ä¸Šé™ | `MAX_FEE_PERCENT = 500` | æœ€é«˜ 5% |
| æ‰¹é‡å¤§å°é™åˆ¶ | `MAX_BATCH_SIZE = 200` | é˜²æ­¢ Gas è¶…é™ |

### âš ï¸ å·²çŸ¥é£é™©ä¸ç¼“è§£

| é£é™© | ä¸¥é‡ç¨‹åº¦ | ç¼“è§£æªæ–½ |
|------|----------|----------|
| Oracle å¯†é’¥æ³„éœ² | é«˜ | TLSNotary å…¬å¼€è¯æ˜å¯å®¡è®¡ |
| ç­¾åæ— è¿‡æœŸæ—¶é—´ | ä¸­ | **å¾…å®ç°**: æ·»åŠ  deadline å­—æ®µ |
| å•ç‚¹ Oracle | ä¸­ | **å¾…å®ç°**: å¤šç­¾ Oracle |
| é‡‘åº“æ™ºèƒ½åˆçº¦é£é™© | ä½ | ä½¿ç”¨ç»å®¡è®¡çš„ Aave åè®® |

### ğŸ” EIP-712 ç­¾åç»“æ„

```solidity
bytes32 private constant LISTING_TYPEHASH = keccak256(
    "ListingData(uint64 assetId,uint48 itemSpec,uint56 price,bytes32 nonce)"
);

// åŸŸåˆ†éš”ç¬¦
EIP712Domain {
    name: "JJSKIN",
    version: "1",
    chainId: <å½“å‰é“¾ ID>,
    verifyingContract: <åˆçº¦åœ°å€>
}
```

---

## Gas ä¼˜åŒ–

### å·²å®ç°çš„ä¼˜åŒ–

| ä¼˜åŒ– | èŠ‚çœ | è¯´æ˜ |
|------|------|------|
| å• Slot ç»“æ„ä½“ | ~20,000 Gas/äº¤æ˜“ | Listing å’Œ Purchase å„å  1 slot |
| æ‰¹é‡é‡Šæ”¾ | ~15,000 Gas/ç¬” | èšåˆå¤šç¬”é‡Šæ”¾å‡å°‘ overhead |
| æ‰‹ç»­è´¹ç´¯ç§¯ | ~5,000 Gas/ç¬” | ä¸é€ç¬”è½¬è´¦ï¼Œç´¯ç§¯åæ‰¹é‡æå– |
| Calldata å‚æ•° | ~200 Gas/ç¬” | ä½¿ç”¨ calldata è€Œé memory |
| Immutable å˜é‡ | ~100 Gas/è¯»å– | usdcToken, walletFactory |
| è‡ªå®šä¹‰é”™è¯¯ | ~200 Gas/å›æ»š | ç›¸æ¯” require å­—ç¬¦ä¸² |

### å¾…ä¼˜åŒ–é¡¹

```solidity
// å½“å‰
for (uint256 i = 0; i < assetIds.length; i++) {

// ä¼˜åŒ–å (èŠ‚çœ ~5 Gas/è¿­ä»£)
for (uint256 i = 0; i < assetIds.length; ) {
    // ...
    unchecked { ++i; }
}
```

---

## éƒ¨ç½²ä¸æµ‹è¯•

### æœ¬åœ°æµ‹è¯•

```bash
# å®‰è£…ä¾èµ–
forge install

# è¿è¡Œæµ‹è¯•
forge test

# è¿è¡Œç‰¹å®šæµ‹è¯•æ–‡ä»¶
forge test --match-path test/CS2MarketplaceV2.t.sol

# æŸ¥çœ‹ Gas æŠ¥å‘Š
forge test --gas-report

# æŸ¥çœ‹è¦†ç›–ç‡
forge coverage
```

### æµ‹è¯•å¥—ä»¶

| æ–‡ä»¶ | æµ‹è¯•æ•° | è¯´æ˜ |
|------|--------|------|
| `CS2MarketplaceV2.t.sol` | 20 | æ ¸å¿ƒåŠŸèƒ½æµ‹è¯• |
| `CS2MarketplaceV2Security.t.sol` | 21 | å®‰å…¨æ€§æµ‹è¯• |
| `CS2MarketplaceV2Comprehensive.t.sol` | 41 | å®Œæ•´æµç¨‹æµ‹è¯• |
| `CS2AaveVault.t.sol` | 23 | æ”¶ç›Šé‡‘åº“æµ‹è¯• |
| **æ€»è®¡** | **105** | - |

---

## è®¸å¯è¯

MIT License

---

## è”ç³»æ–¹å¼

- **GitHub**: [JJSKIN](https://github.com/jjskin)
- **æ–‡æ¡£**: [docs.jjskin.io](https://docs.jjskin.io)
